<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>AI GCam Stabilizer Pro</title>
<script async src="https://docs.opencv.org/4.x/opencv.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body {background:#000;color:#fff;font-family:sans-serif;overflow:hidden;}
video,canvas{position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;}
#ui{position:fixed;bottom:0;left:0;width:100%;padding:16px;background:linear-gradient(to top,rgba(0,0,0,0.8),transparent);}
.mode-btn{font-size:.8rem;opacity:.6;}
.mode-btn.active{opacity:1;font-weight:600;}
</style>
</head>
<body>
<video id="video" autoplay playsinline muted></video>
<canvas id="canvas"></canvas>

<div id="ui" class="flex flex-col items-center space-y-3">
  <div class="flex justify-around w-full text-gray-400 text-sm">
    <button class="mode-btn active" data-mode="normal">Normal</button>
    <button class="mode-btn" data-mode="steady">Steady</button>
  </div>
  <div class="flex justify-center items-center space-x-8">
    <button id="swapCam" class="p-3 bg-gray-700 rounded-full">‚Ü∫</button>
    <button id="toggle" class="w-20 h-20 bg-white rounded-full border-4 border-gray-400"></button>
    <button id="lensBtn" class="p-3 bg-gray-700 rounded-full">1x</button>
  </div>
  <div id="msg" class="text-xs text-gray-400"></div>
</div>

<script>
let stream=null, facing='environment', lensZoom=1, mode='normal';
let cap, running=false, rafId=null, prevGray=null, hist=[], smoother;
const video=document.getElementById('video');
const canvas=document.getElementById('canvas');
const ctx=canvas.getContext('2d');
const msg=document.getElementById('msg');

// === Simple adaptive smoother (AI Kalman-like) ===
class AdaptiveSmoother {
  constructor(){this.x=[0,0];this.last=[0,0];}
  update(mx,my,alpha){this.x[0]=this.x[0]*(1-alpha)+mx*alpha;this.x[1]=this.x[1]*(1-alpha)+my*alpha;return{x:this.x[0],y:this.x[1]};}
}

// === Start camera ===
async function startCamera(){
  try{
    stream && stream.getTracks().forEach(t=>t.stop());
    stream=await navigator.mediaDevices.getUserMedia({
      video:{facingMode:{ideal:facing}},
      audio:false
    });
    video.srcObject=stream;
    await video.play();
    cap=new cv.VideoCapture(video);
    smoother=new AdaptiveSmoother();
    running=true;
    msg.textContent='üì∏ Kamera aktif ('+facing+')';
    processLoop();
  }catch(e){msg.textContent='‚ö†Ô∏è '+e.message;}
}

// === Processing loop ===
async function processLoop(){
  if(!running)return;
  let src=new cv.Mat(video.videoHeight,video.videoWidth,cv.CV_8UC4);
  cap.read(src);
  let gray=new cv.Mat();
  cv.cvtColor(src,gray,cv.COLOR_RGBA2GRAY);

  if(!prevGray){
    prevGray=new cv.Mat();gray.copyTo(prevGray);
    cv.imshow('canvas',src);
  } else {
    let flow=new cv.Mat();
    cv.calcOpticalFlowFarneback(prevGray,gray,flow,0.5,3,15,3,5,1.2,0);
    const f32=flow.data32F, w=flow.cols, h=flow.rows;
    let sx=0,sy=0,c=0,stride=8;
    for(let y=0;y<h;y+=stride){for(let x=0;x<w;x+=stride){let i=(y*w+x)*2;sx+=f32[i];sy+=f32[i+1];c++;}}
    let mx=sx/c, my=sy/c;

    const alpha=mode==='steady'?0.05:0.15;
    const s=smoother.update(mx,my,alpha);
    const dx=-s.x*2, dy=-s.y*2;

    const M=cv.matFromArray(2,3,cv.CV_64F,[1,0,dx,0,1,dy]);
    let out=new cv.Mat();
    cv.warpAffine(src,out,M,src.size(),cv.INTER_LINEAR,cv.BORDER_CONSTANT,new cv.Scalar());
    cv.imshow('canvas',out);

    M.delete();out.delete();flow.delete();prevGray.delete();prevGray=gray.clone();
  }
  src.delete();gray.delete();
  rafId=requestAnimationFrame(processLoop);
}

// === Controls ===
document.getElementById('swapCam').onclick=()=>{facing=facing==='environment'?'user':'environment';startCamera();};
document.getElementById('lensBtn').onclick=()=>{
  lensZoom=lensZoom===1?0.5:1;
  document.getElementById('lensBtn').textContent=lensZoom===1?'1x':'0.5x';
  startCamera();
};
document.querySelectorAll('.mode-btn').forEach(btn=>{
  btn.onclick=()=>{document.querySelectorAll('.mode-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');mode=btn.dataset.mode;msg.textContent='Mode: '+mode;};
});
document.getElementById('toggle').onclick=()=>{
  if(running){running=false;cancelAnimationFrame(rafId);stream.getTracks().forEach(t=>t.stop());msg.textContent='‚è∏Ô∏è Kamera berhenti';}
  else startCamera();
};

navigator.permissions && navigator.permissions.query({name:'camera'}).then(p=>{
  if(p.state!=='granted')msg.textContent='üîí Izinkan kamera...';
});
</script>
</body>
</html>
